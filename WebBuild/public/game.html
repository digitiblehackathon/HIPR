<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>HIPR</title>
	<script src="Build/UnityLoader.js"></script>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E=" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <link rel="stylesheet" href="stylesheets/style.css">

    <!-- STEP 1. define gameInstance -->

    <script type="text/javascript">
        
        // just comment game instance if Unity
        /*var gameInstance = {
            SetFullscreen: (v) => {
                console.log('SetFullscreen', v)
            },
            SendMessage: (interactor, fn, message) => {
                console.log('SendMessage', interactor, fn, message)
            }
        }*/
    </script>

    <!-- STEP 2. load metamask web3 -->

    <script src="javascripts/config.js"></script>
    <script src="javascripts/web3-client-internal.js"></script>

    <!-- STEP 3. connect to hipr browser internal -->

    <script src="javascripts/hipr-browser-internal.js"></script>

    <!-- STEP 4. define internal api -->
    
    <script type="text/javascript">
        // API

        // CALLBACK

        function SendResultBack(key, result)
        {
            var message = key + "#" + result;
            console.log('SendResultBack', message)
            gameInstance.SendMessage('JavascriptInteractor', 'ProcessResult', message);
        }

        // METHODS

		function GetEndOfSeasonInternal()
		{
			SendResultBack("GetEndOfSeason", "1547510399000");
		}

        function GetPuzzleInternal()
        {
            //HIPRInternal.GetPuzzle()
            SendResultBack("GetPuzzle", "ajdhajsndjsadjsah");
        }

        function GetTopScoresInternal(count)
        {
            HIPRInternal.GetTopScores(count)
            // -> "0x111111111|15;0x22222222|12;0x33333333|11;0x444444444|9;0x555555555|3;"
        }

        function SetScoreInternal(score)
        {
            HIPRInternal.SetScore(score);
            // -> "true"
        }

        function ValidatePuzzleResultInternal(resultHash)
        {
            SendResultBack('ValidatePuzzleResult', 'true');
            //return HIPRInternal.ValidatePuzzleResult();
            // -> "true"
        }
    </script>

    <!-- STEP 5. onload init web3 -->
    
<!--    <script src="Build/UnityLoader.js"></script> -->
    <script>
    	window.addEventListener('load', async () => {
            // Modern dapp browsers...
            if (window.ethereum) {
                window.web3 = new Web3(ethereum);
                try {
                    // Request account access if needed
                    await ethereum.enable();
                    // Acccounts now exposed
                    OnCheckingDone();
                } 
                catch (error) {
                    OnError("User denied access to Metamask for this app");
                }
            }
            // Legacy dapp browsers...
            else if (window.web3) {
                window.web3 = new Web3(web3.currentProvider);
                // Acccounts always exposed
                OnCheckingDone();
            }
            // Non-dapp browsers...
            else {
                OnError('Non-Ethereum browser detected. You should consider trying MetaMask!');
            }
        });

    	function OnCheckingDone()
    	{
    		if(typeof(window.web3.eth.accounts[0]) == 'undefined')
    		{
    			OnError("Please log into Metamask to play on HIPR.");
    		}
    		else
    		{                
                if (window.UnityLoader)
                    gameInstance = UnityLoader.instantiate("gameContainer", "Build/public.json");
                
                HIPRInternal.init()
    		}
    	}

    	function OnError(message)
    	{
//            window.location.href = "/";
    	}

    </script>

</head>
<body style="background: rgb(35, 31, 32); margin:0;">
    <div id="gameContainer" style="width: 100%; height: 100%; position: absolute; margin: 0px; top: 0px; left: 0px; bottom: 0px; right: 0px; padding: 0px; border: 0px; background: rgb(35, 31, 32);"></div>
  

	<div id="menu" class="hide">
		<div class="dialog">
			<div class="title">Top 50 Players</div>
			<div class="podium">
				<table style="border-spacing: 0">
					<tbody>
						<tr>
							<td colspan="4">
								<div id="score_number_one" class="entry"><div class="address">0xf55f45267258EFbFCefB795a688630A26576635e</div><div class="score">54552</div></div>
							</td>
						</tr>
						<tr>
							<td class="podium-cell">1째</td>
							<td colspan="3">
								<div id="score_number_two" class="entry"><div class="address">0xf55f45267258EFbFCefB795a688630A26576635e</div><div class="score">54552</div></div>
							</td>
						</tr>
						<tr>
							<td class="podium-cell"></td>
							<td class="podium-cell">2째</td>
							<td colspan="2">
								<div id="score_number_three" class="entry"><div class="address">0xf55f45267258EFbFCefB795a688630A26576635e</div><div class="score">54552</div></div>
							</td>
						</tr>
						<tr>
							<td class="podium-cell"></td>
							<td class="podium-cell"></td>
							<td class="podium-cell">3째</td>
							<td></td>
						</tr>
					</tbody>
				</table>
			</div>
			<div class="scores-list">
				<ul>

				</ul>
			</div>
		</div>
	</div>
	
	<div id="menu_toggle">&equiv;</div>
	
	<script>
		jQuery("#menu_toggle").on("click", function(event) {
			var menu = jQuery("#menu");
			if(menu.hasClass("hide"))
			{
				HIPRInternal.GetTopScoresForMenu(50, function(result) {
					//console.log(result);

					var list = jQuery("#menu .scores-list > ul");
					list.html("");
					
					result.forEach(function(item, index) {
						if(index < 3)
						{
							let address = item.value[0];
							let score = item.value[1];
							if(index == 0)
							{
								jQuery("#score_number_one .address").html(address);
								jQuery("#score_number_one .score").html(score);
							}
							if(index == 1)
							{
								jQuery("#score_number_two .address").html(address);
								jQuery("#score_number_two .score").html(score);
							}
							if(index == 2)
							{
								jQuery("#score_number_three .address").html(address);
								jQuery("#score_number_three .score").html(score);
							}
							return;
						}
						//console.log(item.value[0] + ", " + item.value[1]);
						let address = item.value[0];
						let score = item.value[1];
						list.append('<li><div class="entry-container"><span class="position">' + (index + 1) + '째</span><div class="entry"><div class="address">' + address + '</div><div class="score">' + score + '</div></div></div></li>');
					});

					menu.removeClass("hide");
				});
			}
			else
			{
				menu.addClass("hide");
			}
		});

    </script>
</body>
</html>
